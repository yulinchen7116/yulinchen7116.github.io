<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Neurosynth Frontend (React Autocomplete)</title>
  <link rel="stylesheet" href="./public/styles.css"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:#0f172a}
    .container{max-width:960px;margin:2rem auto;padding:1rem}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:.5rem .75rem;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input{flex:1;border:1px solid #cbd5e1;border-radius:10px;padding:.5rem .75rem}
    .hint{font-size:12px;color:#64748b;margin-top:.25rem}
    .suggest{position:absolute;z-index:9999;margin-top:4px;width:100%;max-height:16rem;overflow:auto;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .suggest li{padding:.5rem .75rem;cursor:pointer}
    .suggest li:hover,.suggest li.active{background:#f1f5f9}
    pre{white-space:pre-wrap;background:#0b1020;color:#e6edf3;padding:12px;border-radius:10px;min-height:120px}
    .badge{display:inline-flex;align-items:center;gap:.4ch;padding:.2rem .6rem;border-radius:999px;font-size:12px}
    .ok{background:#dcfce7;color:#166534}
    .bad{background:#fee2e2;color:#991b1b}

    /* table styles */
    .table-wrap{overflow:auto;border:1px solid #e2e8f0;border-radius:10px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:520px}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e2e8f0;font-weight:600;text-align:left;padding:.6rem .75rem}
    tbody td{padding:.55rem .75rem;border-bottom:1px solid #f1f5f9;vertical-align:top}
    tbody tr:nth-child(odd){background:#ffffff}
    tbody tr:nth-child(even){background:#fbfdff}
    .num{color:#475569;width:64px}
    code.slim{background:#f1f5f9;padding:.1rem .35rem;border-radius:6px}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* ====== 設定（預設 mil；必要時改成 hpc） ====== */
    const BASE = 'https://mil.psy.ntu.edu.tw:5000';
    // const BASE = 'https://hpc.psy.ntu.edu.tw:5000';

    /* ====== 小工具 ====== */
    function useDebounced(value, delay=200) {
      const [v, setV] = useState(value);
      useEffect(() => {
        const t = setTimeout(() => setV(value), delay);
        return () => clearTimeout(t);
      }, [value, delay]);
      return v;
    }

    async function fetchFlexible(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) {
        const txt = await r.text().catch(()=> '');
        throw new Error(`HTTP ${r.status} ${r.statusText}\n\n${txt}`);
      }
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) return r.json();
      const txt = await r.text();
      try { return JSON.parse(txt); } catch { return txt; }
    }

    // 從 payload 裡抓到陣列（支援 related/terms/data/results）
    function extractArray(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.related)) return payload.related;
      if (payload && Array.isArray(payload.terms))   return payload.terms;
      if (payload && Array.isArray(payload.data))    return payload.data;
      if (payload && Array.isArray(payload.results)) return payload.results;
      return null;
    }

    /* ====== DataTable：漂亮表格（字串陣列 / 物件陣列皆可） ====== */
    function DataTable({ items, prefer='terms' }) {
      if (!items || items.length===0) {
        return <div style={{color:'#64748b'}}>（尚無結果）</div>;
      }

      const formatCell = (k, v) => {
        if (v == null) return '';
        if (typeof v === 'number') {
          if (k.toLowerCase().includes('jaccard') || k.toLowerCase().includes('score')) {
            return v.toFixed(4);
          }
          return v; // 其他數字保持原樣（例如 co_count）
        }
        if (Array.isArray(v)) return v.join(', ');
        if (typeof v === 'object') return JSON.stringify(v);
        return String(v);
      };

      // 字串陣列 → 二欄（#、Term）
      if (typeof items[0] === 'string') {
        return (
          <div className="table-wrap">
            <table>
              <thead>
                <tr><th className="num">#</th><th>Term</th></tr>
              </thead>
              <tbody>
                {items.map((t,i)=>(
                  <tr key={i}>
                    <td className="num">{i+1}</td>
                    <td><code className="slim">{t}</code></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      // 物件陣列 → 選欄位
      const pickCols = (prefer) => {
        // 若是 related 這種，優先選這些欄位
        const commonPref = (prefer==='studies')
          ? ['id','title','pmid','journal','year','authors','score','count']
          : ['term','co_count','jaccard','association','weight','score','count','id','title'];
        const keys = new Set();
        commonPref.forEach(k=>{
          if (items.some(x=>x && Object.prototype.hasOwnProperty.call(x,k))) keys.add(k);
        });
        if (keys.size < 6) {
          const extra = Object.keys(items[0]||{});
          for (const k of extra) {
            if (!keys.has(k)) keys.add(k);
            if (keys.size>=6) break;
          }
        }
        return Array.from(keys);
      };

      const cols = pickCols(prefer);

      return (
        <div className="table-wrap">
          <table>
            <thead>
              <tr>
                <th className="num">#</th>
                {cols.map(c=><th key={c}>{c}</th>)}
              </tr>
            </thead>
            <tbody>
              {items.map((row,i)=>(
                <tr key={i}>
                  <td className="num">{i+1}</td>
                  {cols.map(c=> <td key={c}>{formatCell(c, row?.[c])}</td>)}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    /* ====== Autocomplete（本地快取即時建議） ====== */
    function Autocomplete({ terms, onPick, minChars = 1, placeholder = 'e.g., amygdala' }) {
      const [q, setQ] = useState('');
      const [open, setOpen] = useState(false);
      const [active, setActive] = useState(-1);
      const inputRef = useRef(null);
      const listRef  = useRef(null);

      const debounced = useDebounced(q, 120);

      const onFocus = () => {
        if (q.trim().length >= minChars) setOpen(true);
      };

      const list = useMemo(() => {
        const p = debounced.trim().toLowerCase();
        if (p.length < minChars) return [];
        return terms.filter(t => t.toLowerCase().startsWith(p)).slice(0, 30);
      }, [debounced, terms, minChars]);

      useEffect(() => {
        if (list.length) { setOpen(true); setActive(-1); }
        else { setOpen(false); setActive(-1); }
      }, [list]);

      const pick = (term) => {
        setQ(term);
        setOpen(false);
        onPick?.(term);
      };

      const onKeyDown = (e) => {
        if (!open) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); setActive(a => (a + 1) % list.length); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setActive(a => (a - 1 + list.length) % list.length); }
        else if (e.key === 'Enter') { e.preventDefault(); if (active >= 0) pick(list[active]); else if (q.trim()) onPick?.(q.trim()); }
        else if (e.key === 'Escape') { setOpen(false); }
      };

      useEffect(() => {
        const onDoc = (e) => {
          if (!listRef.current || !inputRef.current) return;
          if (listRef.current.contains(e.target) || inputRef.current.contains(e.target)) return;
          setOpen(false);
        };
        document.addEventListener('mousedown', onDoc);
        return () => document.removeEventListener('mousedown', onDoc);
      }, []);

      const qLower = q.toLowerCase();

      return (
        <div style={{ position:'relative' }}>
          <div className="row">
            <input
              ref={inputRef}
              className="input"
              placeholder={placeholder}
              value={q}
              onInput={e => setQ(e.currentTarget.value)}
              onFocus={onFocus}
              onKeyDown={onKeyDown}
              autoComplete="off"
              aria-autocomplete="list"
              aria-expanded={open}
              aria-controls="term-suggest"
            />
            <button className="btn" onClick={() => q.trim() && onPick(q.trim())}>Lookup</button>
          </div>

          {open && list.length > 0 && (
            <ul id="term-suggest" ref={listRef} className="suggest" role="listbox">
              {list.map((t, i) => {
                const pre  = t.slice(0, qLower.length);
                const rest = t.slice(qLower.length);
                return (
                  <li
                    key={t}
                    role="option"
                    className={i === active ? 'active' : ''}
                    onMouseDown={(e) => { e.preventDefault(); }}
                    onClick={() => pick(t)}
                    onMouseEnter={() => setActive(i)}
                  >
                    <b>{pre}</b>{rest}
                  </li>
                );
              })}
            </ul>
          )}
          <div className="hint">隨打字即時建議；↑/↓ 選取、Enter 確認、Esc 關閉。</div>
        </div>
      );
    }

    /* ====== App ====== */
    function App(){
      const [status, setStatus]     = useState('checking');
      const [terms, setTerms]       = useState([]);
      const [response, setResponse] = useState('Ready.');
      const [cards, setCards]       = useState([]);
      const [resultKind, setResultKind] = useState(''); // 'terms' | 'studies'
      const [lastPayload, setLastPayload] = useState(null); // 給 Response 區判斷

      // 啟動時載入 /terms（一次，供 autocomplete）
      useEffect(() => {
        (async () => {
          try{
            setResponse(`Loading: ${BASE}/terms ...`);
            const payload = await fetchFlexible(`${BASE}/terms`);
            const arr = extractArray(payload);
            if (arr) {
              setTerms(arr);
              setStatus('online');
              setResponse(`Loaded ${arr.length} terms`);
            } else {
              setTerms([]);
              setStatus('online');
              setResponse('Loaded /terms but unrecognized shape; autocomplete disabled.');
            }
          } catch (e){
            setStatus('offline');
            setResponse('Failed to load /terms: ' + (e.message || String(e)));
          }
        })();
      }, []);

      // /terms/<t1> → Response 用表格呈現
      const lookupTerm = async (t1) => {
        try {
          setResponse(`Requesting: ${BASE}/terms/${encodeURIComponent(t1)} ...`);
          setCards([]);
          setResultKind('terms');
          const payload = await fetchFlexible(`${BASE}/terms/${encodeURIComponent(t1)}`);
          setLastPayload(payload);
          setResponse(''); // 不再顯示原始 JSON
          const arr = extractArray(payload) || [];
          setCards(arr);
        } catch (e){
          setLastPayload(null);
          setResponse('Error: ' + (e.message || String(e)));
        }
      };

      // /query/<q>/studies → 維持卡片 & 原始 JSON
      const queryStudies = async (q) => {
        try{
          setResponse(`Requesting: ${BASE}/query/${encodeURIComponent(q)}/studies ...`);
          setCards([]);
          setResultKind('studies');
          const payload = await fetchFlexible(`${BASE}/query/${encodeURIComponent(q)}/studies`);
          setLastPayload(payload);
          setResponse('OK\n' + JSON.stringify(payload, null, 2));
          const arr = extractArray(payload) || [];
          setCards(arr);
        } catch (e){
          setLastPayload(null);
          setResponse('Error: ' + (e.message || String(e)));
        }
      };

      // 供 Response 區用：把 lastPayload 轉為表格資料
      const termsForResponse = useMemo(() => {
        if (resultKind !== 'terms') return [];
        if (!lastPayload) return cards;
        const arr = extractArray(lastPayload);
        return arr || cards;
      }, [resultKind, lastPayload, cards]);

      return (
        <div className="container">
          <header className="row" style={{justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
            <h1 style={{fontWeight:700,fontSize:'22px'}}>LoTUS-BF (React demo)</h1>
            <span className={'badge ' + (status==='online'?'ok':'bad')}>
              • backend {status} — Terms: {terms.length} — host: {new URL(BASE).host}
            </span>
          </header>

          <div className="row" style={{alignItems:'flex-start'}}>
            <div className="card" style={{flex:1}}>
              <h2 style={{fontWeight:600,marginBottom:'8px'}}>Terms</h2>
              <Autocomplete
                terms={terms}
                onPick={lookupTerm}
                minChars={1}
                placeholder="type a term, e.g., amygdala"
              />
            </div>

            <div className="card" style={{flex:1}}>
              <h2 style={{fontWeight:600,marginBottom:'8px'}}>Query Builder</h2>
              <div className="row">
                <input id="q" className="input" placeholder="e.g., amygdala NOT emotion"/>
                <button className="btn" onClick={() => {
                  const q = document.getElementById('q').value.trim();
                  if (q) queryStudies(q);
                }}>Search</button>
              </div>
              <div className="hint">支援 AND / OR / NOT；右側會秀原始 JSON（Terms 則在 Response 區改為表格）。</div>
            </div>
          </div>

          <div className="card" style={{marginTop:'12px'}}>
            <h2 style={{fontWeight:600,marginBottom:'8px'}}>
              {resultKind==='terms' ? 'Related Terms' : 'Studies / Associations'}
            </h2>

            {/* 中段仍維持：Terms →（可留白或加說明），Studies → 卡片 */}
            {resultKind === 'terms'
              ? <div style={{color:'#64748b'}}>（詳細清單請見下方 Response 表格）</div>
              : (
                <div className="row" style={{flexWrap:'wrap'}}>
                  {cards.slice(0, 60).map((x, i) => (
                    <div key={i} className="card" style={{minWidth:'260px',flex:1}}>
                      <div style={{fontWeight:600,marginBottom:'6px'}}>{x.title || x.name || String(x)}</div>
                      {x.id && <div style={{fontSize:'13px',color:'#475569'}}>ID: <code>{x.id}</code></div>}
                      {x.description && <div style={{fontSize:'13px',color:'#475569'}}>{x.description}</div>}
                    </div>
                  ))}
                  {cards.length === 0 && <div style={{color:'#64748b'}}>（尚無結果）</div>}
                </div>
              )
            }
          </div>

          <div className="card" style={{marginTop:'12px'}}>
            <h2 style={{fontWeight:600,marginBottom:'8px'}}>Response</h2>
            {/* ✅ Terms：在 Response 區改用表格清單 */}
            {resultKind === 'terms'
              ? <DataTable items={termsForResponse} prefer="terms" />
              : <pre id="out">{response}</pre>
            }
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
