<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Neurosynth Frontend (React Autocomplete)</title>
  <link rel="stylesheet" href="./public/styles.css"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:#0f172a}
    .container{max-width:960px;margin:2rem auto;padding:1rem}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:.5rem .75rem;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input{flex:1;border:1px solid #cbd5e1;border-radius:10px;padding:.5rem .75rem}
    .hint{font-size:12px;color:#64748b;margin-top:.25rem}
    .suggest{position:absolute;z-index:9999;margin-top:4px;width:100%;max-height:16rem;overflow:auto;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .suggest li{padding:.5rem .75rem;cursor:pointer}
    .suggest li:hover,.suggest li.active{background:#f1f5f9}
    pre{white-space:pre-wrap;background:#0b1020;color:#e6edf3;padding:12px;border-radius:10px;min-height:120px}
    .badge{display:inline-flex;align-items:center;gap:.4ch;padding:.2rem .6rem;border-radius:999px;font-size:12px}
    .ok{background:#dcfce7;color:#166534}
    .bad{background:#fee2e2;color:#991b1b}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useEffect, useMemo, useRef, useState} = React;
    const BASES = [
        'https://mil.psy.ntu.edu.tw:5000',
        'https://hpc.psy.ntu.edu.tw:5000'
    ];

    // debounce hook
    function useDebounced(value, delay=200) {
      const [v, setV] = useState(value);
      useEffect(() => {
        const t = setTimeout(() => setV(value), delay);
        return () => clearTimeout(t);
      }, [value, delay]);
      return v;
    }

    function Autocomplete({ terms, ensureTermsLoaded, onPick, minChars=1, placeholder='e.g., amygdala' }) {
      const [q, setQ] = useState('');
      const [open, setOpen] = useState(false);
      const [active, setActive] = useState(-1);
      const inputRef = useRef(null);
      const listRef  = useRef(null);
      const debounced = useDebounced(q, 120);

      // 若 terms 還沒載到，聚焦時再嘗試載入一次
      const onFocus = () => {
        if (q.trim().length >= 1) setOpen(true);
        }; 
        if (q.trim().length >= minChars) setOpen(true);
      };

      const debounced = useDebounced(q, 120);
      const list = React.useMemo(() => {
        const p = debounced.trim().toLowerCase();
        if (p.length < 1) return [];
        return terms.filter(t => t.toLowerCase().startsWith(p)).slice(0, 30);
    }, [debounced, terms]);

      useEffect(() => {
        if (list.length) { setOpen(true); setActive(-1); }
        else { setOpen(false); setActive(-1); }
      }, [list]);

      const pick = (term) => {
        setQ(term);
        setOpen(false);
        onPick?.(term);
      };

      const onKeyDown = (e) => {
        if (!open) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); setActive(a => (a + 1) % list.length); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setActive(a => (a - 1 + list.length) % list.length); }
        else if (e.key === 'Enter') { e.preventDefault(); if (active >= 0) pick(list[active]); else if (q.trim()) onPick?.(q.trim()); }
        else if (e.key === 'Escape') { setOpen(false); }
      };

      // 點外關閉
      useEffect(() => {
        const onDoc = (e) => {
          if (!listRef.current || !inputRef.current) return;
          if (listRef.current.contains(e.target) || inputRef.current.contains(e.target)) return;
          setOpen(false);
        };
        document.addEventListener('mousedown', onDoc);
        return () => document.removeEventListener('mousedown', onDoc);
      }, []);

      const qLower = q.toLowerCase();

      return (
        <div style={{position:'relative'}}>
          <div className="row">
            <input
              ref={inputRef}
              className="input"
              placeholder={placeholder}
              value={q}
              onInput={e => setQ(e.currentTarget.value)}
              onFocus={onFocus}
              onKeyDown={onKeyDown}
              autoComplete="off"
              aria-autocomplete="list"
              aria-expanded={open}
              aria-controls="term-suggest"
            />
            <button className="btn" onClick={() => q.trim() && onPick(q.trim())}>Lookup</button>
          </div>

          {open && list.length > 0 && (
            <ul id="term-suggest" ref={listRef} className="suggest" role="listbox">
              {list.map((t, i) => {
                const pre = t.slice(0, qLower.length);
                const rest = t.slice(qLower.length);
                return (
                  <li
                    key={t}
                    role="option"
                    className={i === active ? 'active' : ''}
                    onMouseDown={(e) => { e.preventDefault(); }}
                    onClick={() => pick(t)}
                    onMouseEnter={() => setActive(i)}
                  >
                    <b>{pre}</b>{rest}
                  </li>
                );
              })}
            </ul>
          )}
          <div className="hint">隨打字即時建議；↑/↓ 選取、Enter 確認、Esc 關閉。</div>
        </div>
      );
    }

    function App(){
      const [status, setStatus] = useState('checking');   // online / offline / checking
      const [terms, setTerms]   = useState([]);
      const [response, setResponse] = useState('Ready.');
      const [cards, setCards] = useState([]);
      const [retry, setRetry] = useState(0); // 重試次數

      // 供 Autocomplete 呼叫，必要時再載一次 terms
      const ensureTermsLoaded = async () => {
        if (terms.length > 0) return;
        await fetchTerms();
      };

      const fetchTerms = async () => {
        try{
          setResponse(`Loading: ${BASE}/terms ...`);
          const r = await fetch(`${BASE}/terms`);
          if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
          const data = await r.json();
          if (!Array.isArray(data)) throw new Error('Unexpected response for /terms');
          setTerms(data);
          setStatus('online');
          setResponse(`Loaded ${data.length} terms`);
        } catch (e){
          setStatus('offline');
          setResponse('Failed to load /terms: ' + (e.message || String(e)));
        }
      };

      // 啟動時載入
        // 1) 通用抓取 + 彈性解析
        async function fetchFlexible(url) {
        const r = await fetch(url);
        if (!r.ok) {
            const txt = await r.text().catch(()=>'');
            throw new Error(`HTTP ${r.status} ${r.statusText}\n\n${txt}`);
        }
        const ct = r.headers.get('content-type') || '';
        if (ct.includes('application/json')) return r.json();
        const txt = await r.text();
        try { return JSON.parse(txt); } catch { return txt; }
        }
        function extractArray(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.terms))   return payload.terms;
        if (payload && Array.isArray(payload.data))    return payload.data;
        if (payload && Array.isArray(payload.results)) return payload.results;
        return null;
        }

        // 2) 在 App() 裡：用這個版本載入 terms 一次
        const [terms, setTerms] = React.useState([]);
        const [status, setStatus] = React.useState('checking');
        const [response, setResponse] = React.useState('Ready.');

        React.useEffect(() => {
        (async () => {
            try {
            setResponse(`Loading: ${BASE}/terms ...`);
            const payload = await fetchFlexible(`${BASE}/terms`);
            const arr = extractArray(payload);
            if (arr) {
                setTerms(arr);
                setStatus('online');
                setResponse(`Loaded ${arr.length} terms`);
            } else {
                // 就算格式怪，也不要丟錯，一樣先讓頁面可用
                setTerms([]);
                setStatus('online');
                setResponse('Loaded /terms but unrecognized shape; autocomplete disabled.');
            }
            } catch (e) {
            setStatus('offline');
            setResponse('Failed to load /terms: ' + (e.message || String(e)));
            }
        })();
    }, []);

      const queryStudies = async (q) => {
        try{
          setResponse(`Requesting: ${BASE}/query/${encodeURIComponent(q)}/studies ...`);
          setCards([]);
          const r = await fetch(`${BASE}/query/${encodeURIComponent(q)}/studies`);
          const info = `HTTP ${r.status} ${r.statusText}`;
          const ct = r.headers.get('content-type') || '';
          if (!r.ok){
            const txt = await r.text();
            setResponse(info + '\n\n' + txt);
            return;
          }
          if (ct.includes('application/json')){
            const data = await r.json();
            setResponse(info + '\n' + JSON.stringify(data, null, 2));
            setCards(Array.isArray(data) ? data : []);
          } else {
            const txt = await r.text();
            setResponse(info + '\n\n' + txt);
          }
        } catch (e){
          setResponse('Error: ' + (e.message || String(e)));
        }
      };

      return (
        <div className="container">
          <header className="row" style={{justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
            <h1 style={{fontWeight:700,fontSize:'22px'}}>LoTUS-BF (React demo)</h1>
            <span className={'badge ' + (status==='online'?'ok':'bad')}>
              • backend {status} — Terms loaded: {terms.length}
            </span>
          </header>

          <div className="row" style={{alignItems:'flex-start'}}>
            <div className="card" style={{flex:1}}>
              <h2 style={{fontWeight:600,marginBottom:'8px'}}>Terms</h2>
              <Autocomplete
                terms={terms}
                ensureTermsLoaded={ensureTermsLoaded}
                onPick={lookupTerm}
                minChars={1}
                placeholder="type a term, e.g., amygdala"
              />
            </div>

            <div className="card" style={{flex:1}}>
              <h2 style={{fontWeight:600,marginBottom:'8px'}}>Query Builder</h2>
              <div className="row">
                <input id="q" className="input" placeholder="e.g., amygdala NOT emotion"/>
                <button className="btn" onClick={() => {
                  const q = document.getElementById('q').value.trim();
                  if (q) queryStudies(q);
                }}>Search</button>
              </div>
              <div className="hint">支援 AND / OR / NOT；右側會秀原始 JSON。</div>
            </div>
          </div>

          <div className="card" style={{marginTop:'12px'}}>
            <h2 style={{fontWeight:600,marginBottom:'8px'}}>Studies / Associations</h2>
            <div className="row" style={{flexWrap:'wrap'}}>
              {cards.slice(0, 60).map((x, i) => (
                <div key={i} className="card" style={{minWidth:'260px',flex:1}}>
                  <div style={{fontWeight:600,marginBottom:'6px'}}>{x.title || x.name || String(x)}</div>
                  {x.id && <div style={{fontSize:'13px',color:'#475569'}}>ID: <code>{x.id}</code></div>}
                  {x.description && <div style={{fontSize:'13px',color:'#475569'}}>{x.description}</div>}
                </div>
              ))}
              {cards.length === 0 && <div style={{color:'#64748b'}}>（尚無結果）</div>}
            </div>
          </div>

          <div className="card" style={{marginTop:'12px'}}>
            <h2 style={{fontWeight:600,marginBottom:'8px'}}>Response</h2>
            <pre id="out">{response}</pre>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
